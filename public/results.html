<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Analysis Results - Driver Monitoring System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" type="image/x-icon" href="/favicon.ico">

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #fafafa;
  color: #1a1a1a;
  min-height: 100vh;
}

/* ========== HEADER ========== */
.header {
  background: #ffffff;
  border-bottom: 1px solid #e0e0e0;
  padding: 0 40px;
  height: 64px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}

.logo {
  font-size: 20px;
  font-weight: 700;
  color: #000;
  text-decoration: none;
  letter-spacing: -0.3px;
}

.nav-links {
  display: flex;
  gap: 20px;
  align-items: center;
}

.nav-link {
  color: #666;
  text-decoration: none;
  font-size: 14px;
  font-weight: 500;
  transition: color 0.2s;
}

.nav-link:hover {
  color: #000;
}

.back-link {
  background: #f5f5f5;
  color: #333;
  padding: 8px 16px;
  border-radius: 6px;
  text-decoration: none;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.2s;
  border: 1px solid #e0e0e0;
}

.back-link:hover {
  background: #e8e8e8;
  border-color: #d0d0d0;
}

/* ========== MAIN CONTENT ========== */
.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 40px;
}

.page-header {
  margin-bottom: 36px;
}

.page-header h1 {
  font-size: 30px;
  font-weight: 800;
  color: #000;
  margin-bottom: 6px;
  letter-spacing: -0.7px;
}

.page-header p {
  font-size: 15px;
  color: #666;
}

/* ========== RESULTS GRID ========== */
.results-grid {
  display: flex;
  flex-direction: column;
  gap: 28px;
}

.result-card {
  background: #ffffff;
  border: 1px solid #e0e0e0;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  transition: box-shadow 0.2s;
}

.result-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.result-table {
  display: grid;
  grid-template-columns: 440px 1fr;
  min-height: 380px;
}

.image-cell {
  background: #f8f8f8;
  border-right: 1px solid #e0e0e0;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  position: relative;
}

.image-wrapper {
  position: relative;
  max-width: 100%;
  max-height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.result-image {
  display: block;
  max-width: 390px;
  max-height: 380px;
  object-fit: contain;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.detection-canvas {
  position: absolute;
  top: 0;
  left: 0;
  pointer-events: none;
}

.info-cell {
  padding: 32px;
  display: flex;
  flex-direction: column;
}

.info-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e8e8e8;
}

.info-header h3 {
  font-size: 18px;
  font-weight: 700;
  color: #000;
  letter-spacing: -0.3px;
}

.view-details-btn {
  padding: 8px 16px;
  background: #f5f5f5;
  border: 1px solid #d0d0d0;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  color: #444;
  cursor: pointer;
  transition: all 0.2s;
}

.view-details-btn:hover {
  background: #e8e8e8;
  border-color: #b0b0b0;
  transform: translateY(-1px);
}

.warnings-table {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.warning-row {
  display: flex;
  align-items: flex-start;
  padding: 14px 16px;
  border-radius: 6px;
  background: #fafafa;
  border: 1px solid #f0f0f0;
}

.warning-icon {
  width: 36px;
  height: 36px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 16px;
  margin-right: 14px;
  flex-shrink: 0;
}

.warning-icon.danger {
  background: #fee;
  color: #e11d48;
  border: 1px solid #fdd;
}

.warning-icon.safe {
  background: #d1fae5;
  color: #059669;
  border: 1px solid #a7f3d0;
}

.warning-content {
  flex: 1;
}

.warning-label {
  font-size: 14px;
  font-weight: 700;
  color: #000;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.warning-label .highlight {
  color: #e11d48;
}

.warning-label.safe-label .highlight {
  color: #059669;
}

.warning-text {
  font-size: 13px;
  color: #666;
  line-height: 1.5;
}

.warning-count {
  background: #fff;
  color: #666;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
  border: 1px solid #e0e0e0;
}

.no-detections {
  text-align: center;
  color: #999;
  padding: 50px 20px;
  font-size: 14px;
  background: #fafafa;
  border-radius: 8px;
  border: 1px dashed #ddd;
}

/* ========== DETAILED REPORT MODAL ========== */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.75);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-content {
  background: white;
  border-radius: 10px;
  max-width: 900px;
  max-height: 90vh;
  width: 100%;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-header {
  padding: 22px 28px;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #fafafa;
}

.modal-header h2 {
  font-size: 18px;
  font-weight: 700;
  color: #000;
  letter-spacing: -0.3px;
}

.modal-close {
  background: #fff;
  border: 1px solid #d0d0d0;
  width: 30px;
  height: 30px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 18px;
  color: #666;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  font-weight: 400;
}

.modal-close:hover {
  background: #f5f5f5;
  color: #333;
  border-color: #b0b0b0;
}

.modal-body {
  padding: 28px;
  overflow-y: auto;
  background: #fff;
}

.model-section {
  margin-bottom: 28px;
  background: #fafafa;
  border: 1px solid #e8e8e8;
  border-radius: 8px;
  padding: 20px;
}

.model-section:last-child {
  margin-bottom: 0;
}

.model-title {
  font-size: 15px;
  font-weight: 700;
  color: #000;
  margin-bottom: 14px;
  padding-bottom: 10px;
  border-bottom: 2px solid #e0e0e0;
  letter-spacing: -0.2px;
}

.detection-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  background: #fff;
  border-radius: 6px;
  overflow: hidden;
  border: 1px solid #e0e0e0;
}

.detection-table th {
  background: #f5f5f5;
  padding: 10px 12px;
  text-align: left;
  font-weight: 700;
  color: #555;
  border-bottom: 2px solid #e0e0e0;
  text-transform: uppercase;
  font-size: 11px;
  letter-spacing: 0.3px;
}

.detection-table td {
  padding: 10px 12px;
  border-bottom: 1px solid #f0f0f0;
  color: #444;
}

.detection-table tr:last-child td {
  border-bottom: none;
}

.detection-table .class-cell {
  font-weight: 600;
  color: #000;
}

.detection-table .conf-cell {
  font-weight: 600;
  color: #059669;
}

.detection-table .bbox-cell {
  font-family: 'Courier New', monospace;
  font-size: 11px;
  color: #666;
}

.detection-table .source-cell {
  font-size: 11px;
  color: #888;
  font-style: italic;
}

.no-detections-table {
  padding: 24px;
  text-align: center;
  color: #999;
  font-size: 13px;
  background: #fff;
  border-radius: 6px;
  border: 1px dashed #ddd;
}

.no-results-message {
  text-align: center;
  padding: 80px 20px;
  color: #999;
}

.no-results-message h2 {
  font-size: 24px;
  margin-bottom: 12px;
  color: #666;
  font-weight: 700;
}

.no-results-message p {
  font-size: 15px;
  margin-bottom: 28px;
  color: #888;
}

.no-results-message a {
  display: inline-block;
  background: #10b981;
  color: white;
  padding: 12px 28px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.2s;
}

.no-results-message a:hover {
  background: #059669;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
}

/* ========== RESPONSIVE ========== */
@media (max-width: 1024px) {
  .result-table {
    grid-template-columns: 1fr;
  }
  
  .image-cell {
    border-right: none;
    border-bottom: 1px solid #e0e0e0;
    min-height: 300px;
  }
  
  .container {
    padding: 30px 20px;
  }
}

@media (max-width: 640px) {
  .header {
    padding: 0 20px;
  }
  
  .nav-links {
    gap: 12px;
  }
  
  .info-cell {
    padding: 24px 20px;
  }
  
  .modal-body {
    padding: 20px;
  }
}
</style>

</head>

<body>
<!-- HEADER -->
<div class="header">
  <a href="/" class="logo">DMS</a>
  <div class="nav-links">
    <a href="/about.html" class="nav-link">About</a>
    <a href="/" class="back-link">← New Analysis</a>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="container">
  <div class="page-header">
    <h1>Analysis Results</h1>
    <p>Driver behavior detection and safety analysis</p>
  </div>

  <div class="results-grid" id="resultsGrid"></div>

  <div class="no-results-message" id="noResults" style="display: none;">
    <h2>No Results Found</h2>
    <p>Please upload and process images first</p>
    <a href="/">Go to Home</a>
  </div>
</div>

<script>
/* ================= SAFETY INSTRUCTIONS ================= */
const SAFETY_INSTRUCTIONS = {
  'Seatbelt': {
    message: 'Thank you for wearing your seatbelt. Stay safe!',
    type: 'safe',
    keyword: 'Seatbelt Detected'
  },
  'Drinking': {
    message: 'Avoid drinking while driving - it impairs your judgment and reaction time.',
    type: 'danger',
    keyword: 'Drinking Detected'
  },
  'Smoking': {
    message: 'Smoking while driving is distracting and unsafe.',
    type: 'danger',
    keyword: 'Smoking Detected'
  },
  'Phone Usage': {
    message: 'Do not use your phone while driving. Pull over if you need to make a call.',
    type: 'danger',
    keyword: 'Phone Usage Detected'
  },
  'Drowsy': {
    message: 'You appear drowsy. Please take a break and rest immediately.',
    type: 'danger',
    keyword: 'Drowsiness Detected'
  },
  'Eating': {
    message: 'Eating while driving can be distracting. Please focus on the road.',
    type: 'danger',
    keyword: 'Eating Detected'
  },
  'Distracted': {
    message: 'Please focus on the road and eliminate distractions.',
    type: 'danger',
    keyword: 'Distraction Detected'
  }
};

/* ================= LOAD AND DISPLAY RESULTS ================= */
window.onload = () => {
  const resultsData = sessionStorage.getItem('dmsResults');
  
  if (!resultsData) {
    console.log('No results found in session storage');
    document.getElementById('noResults').style.display = 'block';
    return;
  }
  
  const results = JSON.parse(resultsData);
  console.log(`Loaded ${results.length} results`);
  
  const resultsGrid = document.getElementById('resultsGrid');
  
  results.forEach((result, index) => {
    const card = renderResultCard(result, index);
    resultsGrid.appendChild(card);
  });
};

/* ================= RENDER RESULT CARD ================= */
function renderResultCard(result, index) {
  const card = document.createElement('div');
  card.className = 'result-card';
  
  const detectedClasses = Object.keys(result.detections);
  const detectionCounts = {};
  Object.entries(result.detections).forEach(([cls, boxes]) => {
    detectionCounts[cls] = boxes.length;
  });
  
  const instructions = generateSafetyInstructions(detectedClasses, detectionCounts);
  
  const resultTable = document.createElement('div');
  resultTable.className = 'result-table';
  
  // Left: Image
  const imageCell = document.createElement('div');
  imageCell.className = 'image-cell';
  
  const imageWrapper = document.createElement('div');
  imageWrapper.className = 'image-wrapper';
  
  const img = document.createElement('img');
  img.className = 'result-image';
  img.src = result.imageData.dataUrl;
  
  const canvas = document.createElement('canvas');
  canvas.className = 'detection-canvas';
  
  img.onload = () => {
    drawDetections(canvas, img, result.detections);
    syncCanvasWithImage(canvas, img);
  };
  
  window.addEventListener('resize', () => syncCanvasWithImage(canvas, img));
  
  imageWrapper.appendChild(img);
  imageWrapper.appendChild(canvas);
  imageCell.appendChild(imageWrapper);
  
  // Right: Info
  const infoCell = document.createElement('div');
  infoCell.className = 'info-cell';
  
  const infoHeader = document.createElement('div');
  infoHeader.className = 'info-header';
  
  const headerTitle = document.createElement('h3');
  headerTitle.textContent = 'Safety Analysis';
  
  const viewDetailsBtn = document.createElement('button');
  viewDetailsBtn.className = 'view-details-btn';
  viewDetailsBtn.textContent = 'View Detailed Report';
  viewDetailsBtn.onclick = () => showDetailedReport(result.imageData.name, result.rawChaitanya, result.rawSoham, result.detections);
  
  infoHeader.appendChild(headerTitle);
  infoHeader.appendChild(viewDetailsBtn);
  
  const warningsTable = document.createElement('div');
  warningsTable.className = 'warnings-table';
  
  if (instructions.length === 0) {
    warningsTable.innerHTML = '<div class="no-detections">No behaviors detected</div>';
  } else {
    instructions.forEach(instruction => {
      const row = document.createElement('div');
      row.className = 'warning-row';
      
      const icon = document.createElement('div');
      icon.className = `warning-icon ${instruction.type}`;
      icon.textContent = instruction.type === 'safe' ? '✓' : '!';
      
      const content = document.createElement('div');
      content.className = 'warning-content';
      
      const label = document.createElement('div');
      label.className = instruction.type === 'safe' ? 'warning-label safe-label' : 'warning-label';
      
      const highlight = document.createElement('span');
      highlight.className = 'highlight';
      highlight.textContent = instruction.keyword;
      label.appendChild(highlight);
      
      if (instruction.count > 1) {
        const countBadge = document.createElement('span');
        countBadge.className = 'warning-count';
        countBadge.textContent = `${instruction.count}×`;
        label.appendChild(countBadge);
      }
      
      const text = document.createElement('div');
      text.className = 'warning-text';
      text.textContent = instruction.message;
      
      content.appendChild(label);
      content.appendChild(text);
      
      row.appendChild(icon);
      row.appendChild(content);
      warningsTable.appendChild(row);
    });
  }
  
  infoCell.appendChild(infoHeader);
  infoCell.appendChild(warningsTable);
  
  resultTable.appendChild(imageCell);
  resultTable.appendChild(infoCell);
  card.appendChild(resultTable);
  
  return card;
}

/* ================= GENERATE SAFETY INSTRUCTIONS ================= */
function generateSafetyInstructions(detectedClasses, detectionCounts) {
  const instructions = [];
  
  const hasSeatbelt = detectedClasses.includes('Seatbelt');
  
  if (!hasSeatbelt) {
    instructions.push({
      keyword: 'No Seatbelt',
      message: 'Please fasten your seatbelt for your safety.',
      type: 'danger',
      count: 0,
      source: ''
    });
  }
  
  // Sort by priority (dangers first, then safe)
  const sortedClasses = detectedClasses.sort((a, b) => {
    const aType = SAFETY_INSTRUCTIONS[a]?.type || 'danger';
    const bType = SAFETY_INSTRUCTIONS[b]?.type || 'danger';
    if (aType === 'danger' && bType === 'safe') return -1;
    if (aType === 'safe' && bType === 'danger') return 1;
    return 0;
  });
  
  sortedClasses.forEach(unifiedClass => {
    if (SAFETY_INSTRUCTIONS[unifiedClass]) {
      instructions.push({
        keyword: SAFETY_INSTRUCTIONS[unifiedClass].keyword,
        message: SAFETY_INSTRUCTIONS[unifiedClass].message,
        type: SAFETY_INSTRUCTIONS[unifiedClass].type,
        count: detectionCounts[unifiedClass] || 1,
        source: '' // Will be populated if needed
      });
    }
  });
  
  return instructions;
}

/* ================= DRAW DETECTIONS ================= */
function drawDetections(canvas, img, detections) {
  canvas.width = img.naturalWidth;
  canvas.height = img.naturalHeight;
  
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Enhanced drawing settings
  ctx.lineWidth = 4;
  ctx.font = 'bold 18px Inter, sans-serif';
  
  Object.entries(detections).forEach(([cls, boxes]) => {
    const isSafe = SAFETY_INSTRUCTIONS[cls]?.type === 'safe';
    const color = isSafe ? '#10b981' : '#e11d48';
    
    // Since we now have only one box per class (highest confidence), draw it
    boxes.forEach((det, idx) => {
      const [x1, y1, x2, y2] = det.bbox;
      const width = x2 - x1;
      const height = y2 - y1;
      
      // Draw bounding box with rounded corners
      ctx.strokeStyle = color;
      ctx.lineWidth = 4;
      
      const radius = 8;
      ctx.beginPath();
      ctx.moveTo(x1 + radius, y1);
      ctx.lineTo(x2 - radius, y1);
      ctx.quadraticCurveTo(x2, y1, x2, y1 + radius);
      ctx.lineTo(x2, y2 - radius);
      ctx.quadraticCurveTo(x2, y2, x2 - radius, y2);
      ctx.lineTo(x1 + radius, y2);
      ctx.quadraticCurveTo(x1, y2, x1, y2 - radius);
      ctx.lineTo(x1, y1 + radius);
      ctx.quadraticCurveTo(x1, y1, x1 + radius, y1);
      ctx.closePath();
      ctx.stroke();
      
      // Draw label background
      const conf = `${(det.conf * 100).toFixed(0)}%`;
      const modelSource = det.source || '';
      const labelText = `${cls} ${conf}`;
      
      ctx.font = 'bold 16px Inter, sans-serif';
      const textMetrics = ctx.measureText(labelText);
      const textWidth = textMetrics.width;
      const textHeight = 20;
      
      const labelY = y1 > 35 ? y1 - 8 : y1 + height + 8;
      
      // Label background with shadow
      ctx.shadowColor = 'rgba(0,0,0,0.3)';
      ctx.shadowBlur = 8;
      ctx.shadowOffsetY = 2;
      
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.roundRect(x1 - 2, labelY - textHeight - 6, textWidth + 20, textHeight + 12, 6);
      ctx.fill();
      
      // Reset shadow
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      ctx.shadowOffsetY = 0;
      
      // Label text
      ctx.fillStyle = '#ffffff';
      ctx.fillText(labelText, x1 + 8, labelY - 6);
    });
  });
}

/* ================= SYNC CANVAS WITH IMAGE ================= */
function syncCanvasWithImage(canvas, img) {
  const imgRect = img.getBoundingClientRect();
  const imgNaturalWidth = img.naturalWidth;
  const imgNaturalHeight = img.naturalHeight;
  
  const displayAspect = imgRect.width / imgRect.height;
  const naturalAspect = imgNaturalWidth / imgNaturalHeight;
  
  let displayWidth, displayHeight, offsetX = 0, offsetY = 0;
  
  if (displayAspect > naturalAspect) {
    displayHeight = imgRect.height;
    displayWidth = displayHeight * naturalAspect;
    offsetX = (imgRect.width - displayWidth) / 2;
  } else {
    displayWidth = imgRect.width;
    displayHeight = displayWidth / naturalAspect;
    offsetY = (imgRect.height - displayHeight) / 2;
  }
  
  canvas.style.width = displayWidth + 'px';
  canvas.style.height = displayHeight + 'px';
  canvas.style.left = offsetX + 'px';
  canvas.style.top = offsetY + 'px';
}

/* ================= SHOW DETAILED REPORT MODAL ================= */
function showDetailedReport(imageName, rawChaitanya, rawSoham, finalDetections) {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.style.display = 'flex';
  
  const content = document.createElement('div');
  content.className = 'modal-content';
  
  const header = document.createElement('div');
  header.className = 'modal-header';
  
  const title = document.createElement('h2');
  title.textContent = `Detailed Report - ${imageName}`;
  
  const closeBtn = document.createElement('button');
  closeBtn.className = 'modal-close';
  closeBtn.innerHTML = '×';
  closeBtn.onclick = () => document.body.removeChild(modal);
  
  header.appendChild(title);
  header.appendChild(closeBtn);
  
  const body = document.createElement('div');
  body.className = 'modal-body';
  
  // Chaitanya Model Section
  const chaitanyaSection = document.createElement('div');
  chaitanyaSection.className = 'model-section';
  chaitanyaSection.innerHTML = '<div class="model-title">Chaitanya Model Detections</div>';
  
  if (rawChaitanya.length === 0) {
    chaitanyaSection.innerHTML += '<div class="no-detections-table">No detections from this model</div>';
  } else {
    const chaitanyaTable = createDetectionTable(rawChaitanya);
    chaitanyaSection.appendChild(chaitanyaTable);
  }
  
  // Soham Model Section
  const sohamSection = document.createElement('div');
  sohamSection.className = 'model-section';
  sohamSection.innerHTML = '<div class="model-title">Soham Model Detections</div>';
  
  if (rawSoham.length === 0) {
    sohamSection.innerHTML += '<div class="no-detections-table">No detections from this model</div>';
  } else {
    const sohamTable = createDetectionTable(rawSoham);
    sohamSection.appendChild(sohamTable);
  }
  
  // Final Merged Section
  const finalSection = document.createElement('div');
  finalSection.className = 'model-section';
  finalSection.innerHTML = '<div class="model-title">Final Merged Detections (After NMS)</div>';
  
  const finalFlat = [];
  Object.entries(finalDetections).forEach(([cls, boxes]) => {
    boxes.forEach(box => {
      finalFlat.push({
        cls: cls,
        conf: box.conf,
        bbox: box.bbox,
        source: box.source
      });
    });
  });
  
  if (finalFlat.length === 0) {
    finalSection.innerHTML += '<div class="no-detections-table">No final detections</div>';
  } else {
    const finalTable = createDetectionTable(finalFlat);
    finalSection.appendChild(finalTable);
  }
  
  body.appendChild(chaitanyaSection);
  body.appendChild(sohamSection);
  body.appendChild(finalSection);
  
  content.appendChild(header);
  content.appendChild(body);
  modal.appendChild(content);
  
  modal.onclick = (e) => {
    if (e.target === modal) {
      document.body.removeChild(modal);
    }
  };
  
  document.body.appendChild(modal);
}

/* ================= CREATE DETECTION TABLE ================= */
function createDetectionTable(detections) {
  const table = document.createElement('table');
  table.className = 'detection-table';
  
  table.innerHTML = `
    <thead>
      <tr>
        <th>Class</th>
        <th>Confidence</th>
        <th>Bounding Box</th>
        <th>Source</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  `;
  
  const tbody = table.querySelector('tbody');
  
  // Sort by confidence descending
  const sortedDetections = [...detections].sort((a, b) => b.conf - a.conf);
  
  sortedDetections.forEach(det => {
    const row = document.createElement('tr');
    
    const clsCell = document.createElement('td');
    clsCell.className = 'class-cell';
    clsCell.textContent = det.cls;
    
    const confCell = document.createElement('td');
    confCell.className = 'conf-cell';
    confCell.textContent = (det.conf * 100).toFixed(1) + '%';
    
    const bboxCell = document.createElement('td');
    bboxCell.className = 'bbox-cell';
    const [x1, y1, x2, y2] = det.bbox.map(v => Math.round(v));
    bboxCell.textContent = `(${x1}, ${y1}) → (${x2}, ${y2})`;
    
    const sourceCell = document.createElement('td');
    sourceCell.className = 'source-cell';
    sourceCell.textContent = det.source || '-';
    
    row.appendChild(clsCell);
    row.appendChild(confCell);
    row.appendChild(bboxCell);
    row.appendChild(sourceCell);
    
    tbody.appendChild(row);
  });
  
  return table;
}
</script>

</body>
</html>